<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador Listado Imágenes - Pamesa</title>

    <!-- Librerías para leer CSV y Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }

        .controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
        }
        
        .btn-red { background-color: #ce1719; } /* Botón Original */
        .btn-red:hover { background-color: #a31214; }

        .btn-blue { background-color: #0056b3; } /* NUEVO BOTÓN */
        .btn-blue:hover { background-color: #004494; }

        .btn-green { background-color: #28a745; }
        .btn-green:hover { background-color: #218838; }

        /* Estilos Tabla */
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 13px;
            font-family: Arial, sans-serif;
            color: #000;
        }

        th {
            background-color: #bfbfbf;
            border: 1px solid #888;
            padding: 8px;
            text-align: left;
            font-weight: bold;
        }

        td {
            border: 1px solid #888;
            padding: 6px 8px;
            white-space: nowrap;
        }

        tr:nth-child(even) { background-color: #f9f9f9; }

        #status {
            font-weight: bold;
            color: #666;
            margin-left: 10px;
            flex-grow: 1;
        }
    </style>
</head>
<body>

    <div class="controls">
        <h2>Generador de Imágenes</h2>
        <div id="status">Esperando carga...</div>
        
        <!-- Botón Original (Cuadrado + Rectangular) -->
        <button onclick="processSquareAndRect()" class="btn-red">Opción 1: Cuadrado + Rectangular (URL CSV)</button>

        <!-- NUEVO BOTÓN (Solo el más grande) -->
        <button onclick="processMaxFormat()" class="btn-blue">Opción 2: Solo Formato Mayor (Sin 30x30)</button>

        <button onclick="downloadExcel()" class="btn-green">Descargar Excel Actual</button>
    </div>

    <table id="result-table">
        <thead>
            <tr>
                <th>filename</th>
                <th>effect</th>
                <th>name</th>
                <th>finish</th>
                <th>size</th>
                <th>color</th>
                <th>url</th>
            </tr>
        </thead>
        <tbody id="table-body">
            <!-- JS rellenará esto -->
        </tbody>
    </table>

    <script>
        // ==========================================
        // CONFIGURACIÓN
        // ==========================================
        const CSV_MAP = {
            id: 'Id._Articulo',
            efecto: 'Efecto_web',
            nombre: 'Nombre',
            acabado: 'Acabado_pieza_web',
            medida: 'Medida',
            color: 'Color_ok',
            url_csv: 'Url_Imagen_Pieza' // Solo usado en Opción 1
        };

        const CONFIG = {
            csvFileName: './BD-21-11-2025.csv', 
            encoding: 'ISO-8859-1'
        };

        // Ruta fija solicitada para la Opción 2
        const FIXED_URL_BASE = "https://www.pamesa.com/ERP/4.0/empresas/151/045/imagenes/t00010602/";

        let RAW_DATA = [];  // Datos crudos del CSV
        let FINAL_DATA = []; // Datos procesados listos para tabla/excel

        // 1. CARGA INICIAL
        document.addEventListener('DOMContentLoaded', () => {
            loadCSV();
        });

        function loadCSV() {
            document.getElementById('status').innerText = "Leyendo CSV...";
            fetch(CONFIG.csvFileName)
                .then(r => {
                    if(!r.ok) throw new Error("No se encuentra el fichero CSV.");
                    return r.arrayBuffer();
                })
                .then(buffer => {
                    const decoder = new TextDecoder(CONFIG.encoding);
                    const csvText = decoder.decode(buffer);
                    Papa.parse(csvText, {
                        header: true,
                        delimiter: ";",
                        skipEmptyLines: true,
                        complete: function(results) {
                            RAW_DATA = results.data;
                            document.getElementById('status').innerText = `CSV Cargado (${RAW_DATA.length} filas). Elige una opción.`;
                        }
                    });
                })
                .catch(err => {
                    document.getElementById('status').innerText = "Error: " + err.message;
                    document.getElementById('status').style.color = "red";
                });
        }

        // ==========================================
        // OPCIÓN 2: NUEVA FUNCIÓN (SOLICITADA)
        // ==========================================
        function processMaxFormat() {
            if (RAW_DATA.length === 0) return alert("Espera a que cargue el CSV");
            document.getElementById('status').innerText = "Procesando Formato Único (Max Área)...";

            const groups = {};

            RAW_DATA.forEach(row => {
                // 1. Limpieza de datos
                const nombre = (row[CSV_MAP.nombre] || '').replace(/^(CR\.|ES\.)/i, '').trim();
                const efecto = (row[CSV_MAP.efecto] || '').trim();
                const color = (row[CSV_MAP.color] || '').trim();
                const acabado = (row[CSV_MAP.acabado] || '').trim();
                const medida = (row[CSV_MAP.medida] || '').toLowerCase().trim();

                if (!efecto || !nombre) return;

                // 2. EXCLUSIÓN: Si es "30x30", saltamos esta fila
                if (medida === '30x30') return;

                // 3. Clave única de agrupación
                const key = `${efecto}|${nombre}|${color}|${acabado}`;

                // 4. Calcular Área
                const shapeInfo = getShapeAndArea(medida);

                // 5. Comparar: ¿Es esta fila "más grande" que la que ya teníamos?
                if (!groups[key]) {
                    // Es el primero que encontramos
                    groups[key] = { row: row, area: shapeInfo.area };
                } else {
                    // Ya tenemos uno, comparamos áreas
                    if (shapeInfo.area > groups[key].area) {
                        groups[key] = { row: row, area: shapeInfo.area }; // Actualizamos con el ganador
                    }
                }
            });

            // Convertir a lista final
            FINAL_DATA = Object.keys(groups).sort().map(key => {
                const row = groups[key].row;
                const id = row[CSV_MAP.id] || '000000';
                
                // Construcción URL Específica solicitada
                const generatedUrl = `${FIXED_URL_BASE}${id}.jpg`;

                return {
                    filename: `${id}.jpg`,
                    effect: row[CSV_MAP.efecto],
                    name: (row[CSV_MAP.nombre] || '').replace(/^(CR\.|ES\.)/i, '').trim(),
                    finish: row[CSV_MAP.acabado],
                    size: row[CSV_MAP.medida],
                    color: row[CSV_MAP.color],
                    url: generatedUrl
                };
            });

            renderTable();
            document.getElementById('status').innerText = `Opción 2 Lista: ${FINAL_DATA.length} modelos únicos.`;
        }


        // ==========================================
        // OPCIÓN 1: ORIGINAL (Cuadrado + Rect)
        // ==========================================
        function processSquareAndRect() {
            if (RAW_DATA.length === 0) return alert("Espera a que cargue el CSV");
            document.getElementById('status').innerText = "Procesando Cuadrado + Rectangular...";

            const groups = {};

            RAW_DATA.forEach(row => {
                const nombre = (row[CSV_MAP.nombre] || '').replace(/^(CR\.|ES\.)/i, '').trim();
                const efecto = (row[CSV_MAP.efecto] || '').trim();
                const color = (row[CSV_MAP.color] || '').trim();
                const acabado = (row[CSV_MAP.acabado] || '').trim();
                const medida = (row[CSV_MAP.medida] || '').toLowerCase().trim();
                
                if (!efecto || !nombre) return;

                const key = `${efecto}|${nombre}|${color}|${acabado}`;
                if (!groups[key]) groups[key] = { sq: null, rect: null };

                const shapeInfo = getShapeAndArea(medida);
                const current = { row: row, area: shapeInfo.area };

                if (shapeInfo.isSquare) {
                    if (!groups[key].sq || current.area > groups[key].sq.area) groups[key].sq = current;
                } else {
                    if (!groups[key].rect || current.area > groups[key].rect.area) groups[key].rect = current;
                }
            });

            FINAL_DATA = [];
            Object.keys(groups).sort().forEach(key => {
                const g = groups[key];
                if (g.sq) FINAL_DATA.push(formatOutputRowOriginal(g.sq.row));
                if (g.rect) FINAL_DATA.push(formatOutputRowOriginal(g.rect.row));
            });

            renderTable();
            document.getElementById('status').innerText = `Opción 1 Lista: ${FINAL_DATA.length} filas.`;
        }

        // Helper para la opción 1 (usa URL del CSV)
        function formatOutputRowOriginal(row) {
            const id = row[CSV_MAP.id] || '000000';
            return {
                filename: `${id}.jpg`,
                effect: row[CSV_MAP.efecto],
                name: (row[CSV_MAP.nombre] || '').replace(/^(CR\.|ES\.)/i, '').trim(),
                finish: row[CSV_MAP.acabado],
                size: row[CSV_MAP.medida],
                color: row[CSV_MAP.color],
                url: row[CSV_MAP.url_csv] || '' // Usa columna del CSV
            };
        }

        // ==========================================
        // UTILIDADES COMUNES
        // ==========================================
        function getShapeAndArea(medidaStr) {
            if (!medidaStr) return { area: 0, isSquare: false };
            const clean = medidaStr.replace(/,/g, '.');
            const parts = clean.split('x');
            if (parts.length < 2) return { area: 0, isSquare: false };
            const w = parseFloat(parts[0]);
            const h = parseFloat(parts[1]);
            if (isNaN(w) || isNaN(h)) return { area: 0, isSquare: false };
            
            return {
                area: w * h,
                isSquare: Math.abs(w - h) < 0.5
            };
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            const fragment = document.createDocumentFragment();

            FINAL_DATA.forEach(item => {
                const tr = document.createElement('tr');
                const fields = ['filename', 'effect', 'name', 'finish', 'size', 'color', 'url'];
                fields.forEach(field => {
                    const td = document.createElement('td');
                    if (field === 'filename') {
                        td.innerHTML = `<b>${item[field]}</b>`;
                        td.style.backgroundColor = '#ddd';
                    } else if (field === 'url') {
                        // Truncar visualmente la URL si es muy larga, pero el link funciona
                        td.innerHTML = `<a href="${item[field]}" target="_blank" style="color:blue; text-decoration:underline;">${item[field]}</a>`;
                    } else {
                        td.innerText = item[field] || '';
                    }
                    tr.appendChild(td);
                });
                fragment.appendChild(tr);
            });
            tbody.appendChild(fragment);
        }

        function downloadExcel() {
            if (FINAL_DATA.length === 0) return alert("Primero genera un listado con los botones de arriba.");
            const ws = XLSX.utils.json_to_sheet(FINAL_DATA);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Imagenes");
            XLSX.writeFile(wb, "Pamesa_Listado_Imagenes.xlsx");
        }
    </script>
</body>
</html>